<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ロググラフ描画</title>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 20px;
        }

        .container {
            width: 90%;
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
        }

        button {
            display: block;
            width: 200px;
            margin: 20px auto;
            padding: 10px;
            border: none;
            background: #3498db;
            color: white;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        button:hover {
            background: #2980b9;
        }

        #status {
            text-align: center;
            margin-top: 10px;
            color: #555;
        }
    </style>
</head>
<body>
<div class="container">
    <button id="loadBtn">ログを読み込んでグラフ描画</button>
    <div id="status"></div>

    <canvas id="chartCanvas" width="400" height="200"></canvas>
</div>

<script>
    let chart = null;
    
    document.getElementById("loadBtn").addEventListener("click", async () => {
        document.getElementById("status").textContent = "読み込み中…";
    
        try {
            const res = await fetch("log.txt?" + Date.now());
            if (!res.ok) throw new Error("取得に失敗");
    
            const text = await res.text();
            const lines = text.split("\n");
    
            let datasets = [];
            let xs = [];
            let ys = [];
    
            function pushCurrentGraph() {
                // データが揃っていない場合はスキップ
                if (xs.length < 2 || xs.length !== ys.length) {
                    xs = [];
                    ys = [];
                    return;
                }
    
                datasets.push({
                    label: "Graph " + (datasets.length + 1),
                    data: xs.map((x, i) => ({ x: x, y: ys[i] })),
                    borderWidth: 2,
                    pointRadius: 2,
                    fill: false,
                    tension: 0
                });
    
                xs = [];
                ys = [];
            }
    
            for (let line of lines) {
                const trimmed = line.trim();
                console.log(trimmed);
                // 空行で1つのグラフ終了
                if (trimmed === "") {
                    pushCurrentGraph();
                    continue;
                }
    
                const parts = trimmed.split(/\s+/);
                if (parts.length < 2) continue;
    
                const count = Number(parts[0].trim());
                const percent = Number(parts[1].trim());
    
                if (!isNaN(count) && !isNaN(percent)) {
                    xs.push(count);
                    ys.push(percent);
                }
            }
    
            pushCurrentGraph(); // 最後のグラフ
    
            if (chart) chart.destroy();
            const ctx = document.getElementById("chartCanvas").getContext("2d");
    
            chart = new Chart(ctx, {
                type: "line",
                data: { datasets: datasets },
                options: {
                    parsing: false,
                    scales: {
                        x: {
                            type: "linear",
                            title: { display: true, text: "回数" },
                            beginAtZero: true,
                            suggestedMax: 40000
                        },
                        y: {
                            type: "linear",
                            title: { display: true, text: "％" },
                            beginAtZero: true
                        }
                    }
                }
            });
    
            document.getElementById("status").textContent = "読み込み完了！";
    
        } catch (e) {
            document.getElementById("status").textContent = "読み込みエラー: " + e.message;
        }
    });
    </script>
    
</body>
</html>
